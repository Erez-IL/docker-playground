From 6c94d485cb3e23559da8f0356a1052a620d7a2c2 Mon Sep 17 00:00:00 2001
From: Harald Welte <laforge@gnumonks.org>
Date: Mon, 14 May 2018 23:16:51 +0200
Subject: [PATCH] chagnge content-disposition of pdf/image/text/patch to
 'inline'

Related:  https://osmocom.org/issues/3264
---
 app/controllers/attachments_controller.rb | 9 ++++++++-
 app/models/attachment.rb                  | 8 ++++++++
 2 files changed, 16 insertions(+), 1 deletion(-)

diff --git a/app/controllers/attachments_controller.rb b/app/controllers/attachments_controller.rb
index c2b5fa9c8..f2a57c31d 100644
--- a/app/controllers/attachments_controller.rb
+++ b/app/controllers/attachments_controller.rb
@@ -57,7 +57,7 @@ class AttachmentsController < ApplicationController
       # images are sent inline
       send_file @attachment.diskfile, :filename => filename_for_content_disposition(@attachment.filename),
                                       :type => detect_content_type(@attachment),
-                                      :disposition => 'attachment'
+                                      :disposition => disposition(@attachment)
     end
   end
 
@@ -188,4 +188,12 @@ class AttachmentsController < ApplicationController
     end
     content_type.to_s
   end
+
+  def disposition(attachment)
+    if attachment.is_pdf? || attachment.is_image? || attachment.is_diff? || attachment.is_text?
+      'inline'
+    else
+      'attachment'
+    end
+  end
 end
diff --git a/app/models/attachment.rb b/app/models/attachment.rb
index 3d16f57cc..a2520b0d5 100644
--- a/app/models/attachment.rb
+++ b/app/models/attachment.rb
@@ -236,10 +236,18 @@ class Attachment < ActiveRecord::Base
     Redmine::MimeType.is_type?('text', filename)
   end
 
+  def is_image?
+    Redmine::MimeType.is_type?('image', filename)
+  end
+
   def is_diff?
     self.filename =~ /\.(patch|diff)$/i
   end
 
+  def is_pdf?
+    Redmine::MimeType.of(filename) == "application/pdf"
+  end
+
   # Returns true if the file is readable
   def readable?
     File.readable?(diskfile)
-- 
2.17.0

